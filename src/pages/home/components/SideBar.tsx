import { invoke } from "@tauri-apps/api/core";
import React, { ErrorInfo, useContext, useEffect, useState } from "react";
import { closeSnackbar, useSnackbar } from "notistack";
import { Entity } from "../../auth/LoadEntity";
import { ENTITY_KEY } from "../../../utils/constants";
import { useAppDispatch, useAppSelector } from "../../../redux/hooks";
import { setEntity } from "../../../redux/reducers/entityReducer";
import { checkForAppUpdates } from "../../../utils/functions";
let isSyncing = false;
function SideBar() {
  let { enqueueSnackbar: notify } = useSnackbar();
  const dispatch = useAppDispatch();
  const settings = useAppSelector((state) => state.settings);
  const entity = useAppSelector((state) => state.entity);

  const synchronize = async () => {
    console.log(entity.syncTime);
    if (isSyncing) {
      notify("Already Synchronizing, please wait...", {
        variant: "info",
        autoHideDuration: 5000,
      });
      return;
    }
    isSyncing = true;
    let id = notify("Synchronizing...", { persist: true });
    try {
      let {
        message,
        localUpdates,
        cloudUpdates,
        status,
        entity,
      }: {
        message: string;
        localUpdates: number;
        cloudUpdates: number;
        status: boolean;
        entity: Entity;
      } = await invoke("synchronize");
      closeSnackbar(id);
      notify(message, {
        variant: "success",
        autoHideDuration: 30000,
      });
      dispatch(setEntity(entity));
      isSyncing = false;
    } catch (error) {
      closeSnackbar(id);
      isSyncing = false;
      error instanceof Error &&
        notify(error.message, {
          variant: "error",
          autoHideDuration: 60000,
        });
    }
  };
  useEffect(() => {
    setInterval(() => {
      synchronize();
    }, entity.syncTime);
  }, []);
  return (
    <div className={"side-bar " + (settings?.showMenu ? "" : "close")}>
      <a title="TILL" href="/home" className="side-bar__item">
        <svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
          <title />
          <g id="Shops">
            <path
              fill="#3c3633"
              d="M27.92,24.08l-2.24-13A4.73,4.73,0,0,0,21.14,7H21A5,5,0,0,0,11,7h-.14a4.73,4.73,0,0,0-4.54,4.08l-2.24,13a5.23,5.23,0,0,0,1.13,4.29A4.45,4.45,0,0,0,8.62,30H23.38a4.45,4.45,0,0,0,3.41-1.63A5.23,5.23,0,0,0,27.92,24.08ZM16,4a3,3,0,0,1,3,3H13A3,3,0,0,1,16,4Zm9.26,23.08a2.45,2.45,0,0,1-1.88.92H8.62a2.45,2.45,0,0,1-1.88-.92,3.21,3.21,0,0,1-.69-2.66l2.24-13A2.74,2.74,0,0,1,10.86,9H21.14a2.74,2.74,0,0,1,2.57,2.42l2.24,13A3.21,3.21,0,0,1,25.26,27.08Z"
            />
          </g>
        </svg>
        <p>TILL</p>
      </a>

      <a title="STOCK" href="/home/stock" className="side-bar__item">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
          <g id="Layer_25" data-name="Layer 25">
            <path d="M60,3H56.71a1,1,0,0,0-1,1V20.43H53V8.68a1,1,0,0,0-1-1H38.35a1,1,0,0,0-1,1V20.43H34.64V4a1,1,0,0,0-1-1H30.36a1,1,0,0,0-1,1V20.43H26.64V8.68a1,1,0,0,0-1-1H12a1,1,0,0,0-1,1V20.43H8.29V4a1,1,0,0,0-1-1H4A1,1,0,0,0,3,4V60a1,1,0,0,0,1,1H7.29a1,1,0,0,0,1-1V55.71H29.36V60a1,1,0,0,0,1,1h3.28a1,1,0,0,0,1-1V55.71H55.71V60a1,1,0,0,0,1,1H60a1,1,0,0,0,1-1V4A1,1,0,0,0,60,3ZM44,9.68h2.28v2l-.56-.4a1,1,0,0,0-1.15,0l-.57.4Zm-4.68,0H42v3.9a1,1,0,0,0,.54.89,1.07,1.07,0,0,0,.46.11.94.94,0,0,0,.58-.19l1.56-1.11,1.56,1.11a1,1,0,0,0,1,.08,1,1,0,0,0,.54-.89V9.68H51V20.43H39.35Zm-21.67,0H20v2l-.56-.4a1,1,0,0,0-1.16,0l-.56.4ZM13,9.68h2.68v3.9a1,1,0,0,0,.54.89,1,1,0,0,0,.46.11,1,1,0,0,0,.58-.19l1.56-1.11,1.56,1.11a1,1,0,0,0,1,.08,1,1,0,0,0,.54-.89V9.68h2.68V20.43H13ZM55.71,22.43V37.07H53V25.32a1,1,0,0,0-1-1H38.35a1,1,0,0,0-1,1V37.07H34.64V22.43ZM44,26.32h2.28v2l-.55-.4a1,1,0,0,0-1.16,0l-.57.4Zm-1.46,4.79a1.07,1.07,0,0,0,.46.11,1,1,0,0,0,.58-.18l1.56-1.11L46.73,31a1,1,0,0,0,1.58-.81v-3.9H51V37.07H39.35V26.32H42v3.9A1,1,0,0,0,42.57,31.11ZM29.36,22.43V37.07H26.64V25.32a1,1,0,0,0-1-1H12a1,1,0,0,0-1,1V37.07H8.29V22.43ZM17.68,26.32H20v2l-.56-.4a1,1,0,0,0-1.16,0l-.56.4Zm-1.46,4.79a1,1,0,0,0,1-.07l1.56-1.11L20.38,31A1,1,0,0,0,22,30.22v-3.9h2.68V37.07H13V26.32h2.68v3.9A1,1,0,0,0,16.22,31.11ZM6.29,59H5V5H6.29ZM13,53.71V43h2.68v3.9a1,1,0,0,0,.54.89,1,1,0,0,0,1-.07l1.56-1.11,1.56,1.1a.94.94,0,0,0,.58.19,1.11,1.11,0,0,0,.46-.11,1,1,0,0,0,.54-.89V43h2.68V53.71ZM17.68,43H20v2l-.56-.4a1,1,0,0,0-1.16,0l-.56.4Zm9,10.75V42a1,1,0,0,0-1-1H12a1,1,0,0,0-1,1V53.71H8.29V39.07H29.36V53.71Zm6,5.29H31.36V5h1.28Zm6.71-5.29V43H42v3.9a1,1,0,0,0,.54.89,1,1,0,0,0,1-.07l1.56-1.11,1.56,1.1a1,1,0,0,0,.58.19,1.07,1.07,0,0,0,.46-.11,1,1,0,0,0,.54-.89V43H51V53.71ZM44,43h2.28v2l-.56-.4a1,1,0,0,0-1.15,0l-.57.4Zm9,10.75V42a1,1,0,0,0-1-1H38.35a1,1,0,0,0-1,1V53.71H34.64V39.07H55.71V53.71ZM59,59H57.71V5H59Z" />
          </g>
        </svg>
        <p>STOCK</p>
      </a>
      <a
        title="TRANSACTIONS"
        href="/home/transactions"
        className="side-bar__item"
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M21.86 6.67001H16.59V4.55001C16.5874 4.34383 16.5442 4.14018 16.4629 3.9507C16.3815 3.76121 16.2637 3.5896 16.116 3.44567C15.9684 3.30174 15.7938 3.1883 15.6023 3.11183C15.4108 3.03536 15.2062 2.99736 15 3.00001H3.60999C3.0167 2.99998 2.44741 3.23429 2.02602 3.65193C1.60464 4.06957 1.36526 4.63674 1.35999 5.23001V20.52C1.36208 20.617 1.39129 20.7115 1.44431 20.7928C1.49732 20.8741 1.57203 20.939 1.65999 20.98C1.74966 21.0156 1.84735 21.026 1.94251 21.0101C2.03766 20.9943 2.12669 20.9527 2.19999 20.89L3.36999 19.84L4.54999 20.89C4.64186 20.9729 4.76122 21.0188 4.88499 21.0188C5.00875 21.0188 5.12811 20.9729 5.21999 20.89L6.38999 19.84L7.56999 20.89C7.66186 20.9729 7.78122 21.0188 7.90499 21.0188C8.02875 21.0188 8.14811 20.9729 8.23998 20.89L9.41999 19.84L10.59 20.89C10.6819 20.9729 10.8012 21.0188 10.925 21.0188C11.0487 21.0188 11.1681 20.9729 11.26 20.89L12.43 19.84L13.61 20.89C13.6821 20.9548 13.7712 20.9977 13.8669 21.0136C13.9625 21.0295 14.0607 21.0179 14.15 20.98C14.2368 20.9385 14.3101 20.8733 14.3614 20.7919C14.4127 20.7105 14.44 20.6162 14.44 20.52V19.52H21.86C21.9926 19.52 22.1198 19.4673 22.2135 19.3736C22.3073 19.2798 22.36 19.1526 22.36 19.02V7.17001C22.36 7.0374 22.3073 6.91022 22.2135 6.81645C22.1198 6.72269 21.9926 6.67001 21.86 6.67001ZM13.44 4.55001V19.4L12.77 18.8C12.6781 18.7171 12.5587 18.6712 12.435 18.6712C12.3112 18.6712 12.1919 18.7171 12.1 18.8L10.92 19.85L9.74999 18.8C9.65811 18.7171 9.53875 18.6712 9.41499 18.6712C9.29122 18.6712 9.17186 18.7171 9.07999 18.8L7.89999 19.85L6.72999 18.8C6.63701 18.7155 6.51563 18.6691 6.38999 18.67C6.32911 18.6688 6.2686 18.6796 6.21195 18.7019C6.1553 18.7242 6.10365 18.7576 6.05999 18.8L4.87999 19.85L3.70999 18.8C3.61811 18.7171 3.49875 18.6712 3.37499 18.6712C3.25122 18.6712 3.13186 18.7171 3.03999 18.8L2.35999 19.4V5.23001C2.36523 4.90196 2.49924 4.58914 2.7331 4.35902C2.96695 4.12891 3.2819 3.99996 3.60999 4.00001H13.55C13.4804 4.17519 13.4431 4.36153 13.44 4.55001V4.55001ZM14.44 4.55001C14.4474 4.40483 14.5091 4.26775 14.6128 4.16589C14.7165 4.06403 14.8547 4.00483 15 4.00001V4.00001C15.1512 4.00001 15.2961 4.06006 15.403 4.16696C15.5099 4.27385 15.57 4.41883 15.57 4.57001V6.67001H14.44V4.55001ZM21.36 18.55H14.44V11.59H21.36V18.55ZM21.36 10.6H14.44V9.66001H21.36V10.6ZM21.36 8.67001H14.44V7.67001H21.36V8.67001Z"
            fill="black"
          />
          <path
            d="M19.28 15.56C19.3446 15.5626 19.4056 15.5901 19.4503 15.6367C19.4951 15.6833 19.5201 15.7454 19.52 15.81C19.5178 15.8565 19.5027 15.9014 19.4763 15.9398C19.4499 15.9781 19.4134 16.0084 19.3708 16.0271C19.3282 16.0458 19.2812 16.0522 19.2351 16.0457C19.189 16.0391 19.1457 16.0199 19.11 15.99C19.0834 15.965 19.0629 15.9342 19.05 15.9C18.997 15.778 18.8976 15.6821 18.7738 15.6333C18.6501 15.5846 18.512 15.587 18.39 15.64C18.268 15.6931 18.1721 15.7924 18.1233 15.9162C18.0746 16.0399 18.077 16.178 18.13 16.3C18.1943 16.4461 18.2859 16.5784 18.4 16.69C18.509 16.8 18.638 16.8883 18.78 16.95V17.06C18.78 17.1926 18.8327 17.3198 18.9264 17.4136C19.0202 17.5073 19.1474 17.56 19.28 17.56C19.4126 17.56 19.5398 17.5073 19.6336 17.4136C19.7273 17.3198 19.78 17.1926 19.78 17.06V17C19.9994 16.9006 20.1857 16.7404 20.3169 16.5383C20.448 16.3363 20.5185 16.1009 20.52 15.86C20.52 15.5302 20.3897 15.2138 20.1574 14.9796C19.9252 14.7455 19.6098 14.6127 19.28 14.61C19.2154 14.6101 19.1533 14.5851 19.1067 14.5404C19.0601 14.4956 19.0326 14.4346 19.03 14.37C19.03 14.15 19.28 13.98 19.5 14.28C19.553 14.402 19.6524 14.4979 19.7762 14.5467C19.8999 14.5955 20.038 14.5931 20.16 14.54C20.282 14.487 20.3779 14.3876 20.4267 14.2639C20.4755 14.1401 20.473 14.002 20.42 13.88C20.3583 13.735 20.2701 13.6028 20.16 13.49C20.0483 13.3833 19.92 13.2954 19.78 13.23V13.11C19.7774 12.9782 19.7239 12.8525 19.6307 12.7593C19.5375 12.6661 19.4118 12.6126 19.28 12.61C19.1474 12.61 19.0202 12.6627 18.9264 12.7565C18.8327 12.8502 18.78 12.9774 18.78 13.11V13.23C18.5599 13.3189 18.3697 13.4686 18.2316 13.6616C18.0934 13.8547 18.0131 14.083 18 14.32C17.9999 14.4863 18.0333 14.6509 18.0981 14.804C18.1629 14.9571 18.2578 15.0956 18.3772 15.2113C18.4966 15.327 18.6381 15.4174 18.7932 15.4774C18.9483 15.5373 19.1138 15.5654 19.28 15.56V15.56Z"
            fill="black"
          />
          <path
            d="M7.91 8.78001C7.97893 8.79276 8.04123 8.82924 8.08607 8.88313C8.1309 8.93702 8.15546 9.00491 8.15546 9.07501C8.15546 9.14512 8.1309 9.21301 8.08607 9.2669C8.04123 9.32078 7.97893 9.35727 7.91 9.37001C7.83228 9.37156 7.75699 9.34288 7.7 9.29001C7.67338 9.25911 7.64993 9.2256 7.63 9.19001C7.60616 9.12709 7.56986 9.06962 7.52327 9.02106C7.47669 8.9725 7.42079 8.93384 7.35891 8.9074C7.29703 8.88096 7.23045 8.86728 7.16316 8.86719C7.09587 8.86709 7.02925 8.88058 6.96729 8.90684C6.90534 8.9331 6.84932 8.9716 6.8026 9.02003C6.75588 9.06846 6.71942 9.12582 6.69539 9.18867C6.67137 9.25153 6.66028 9.31859 6.66279 9.38583C6.6653 9.45308 6.68136 9.51912 6.71 9.58001C6.77543 9.73919 6.87433 9.88243 7 10C7.11916 10.1167 7.25795 10.2115 7.41 10.28V10.42C7.41 10.5526 7.46268 10.6798 7.55645 10.7736C7.65021 10.8673 7.77739 10.92 7.91 10.92C8.04261 10.92 8.16978 10.8673 8.26355 10.7736C8.35732 10.6798 8.41 10.5526 8.41 10.42V10.28C8.69077 10.1693 8.92385 9.9637 9.06867 9.69892C9.21349 9.43413 9.26089 9.12695 9.20261 8.83083C9.14434 8.5347 8.98408 8.26839 8.74973 8.07822C8.51538 7.88805 8.22178 7.78606 7.92 7.79001C7.88023 7.79141 7.84059 7.78461 7.80356 7.77003C7.76653 7.75544 7.7329 7.7334 7.70476 7.70525C7.67662 7.67711 7.65457 7.64348 7.63999 7.60645C7.62541 7.56942 7.6186 7.52979 7.62 7.49001C7.62253 7.43326 7.64112 7.37839 7.67361 7.33178C7.7061 7.28518 7.75115 7.24876 7.80353 7.22676C7.85591 7.20476 7.91346 7.19809 7.96949 7.20752C8.02551 7.21694 8.0777 7.24208 8.12 7.28001C8.14885 7.30912 8.17253 7.34294 8.19 7.38001C8.25302 7.48005 8.34945 7.55452 8.46217 7.5902C8.5749 7.62587 8.69661 7.62045 8.80572 7.57489C8.91482 7.52933 9.00425 7.44658 9.05812 7.34134C9.112 7.23609 9.12684 7.11516 9.1 7.00001C9.03627 6.84532 8.94089 6.70567 8.82 6.59001C8.70433 6.46452 8.56033 6.36852 8.4 6.31001V6.14001C8.4 6.00741 8.34732 5.88023 8.25355 5.78646C8.15978 5.69269 8.03261 5.64001 7.9 5.64001C7.76819 5.64257 7.6425 5.69608 7.54928 5.78929C7.45606 5.88251 7.40256 6.00821 7.4 6.14001V6.29001C7.1279 6.40964 6.90502 6.61889 6.76848 6.8829C6.63194 7.14692 6.59 7.44975 6.64964 7.74093C6.70928 8.03212 6.8669 8.29407 7.09624 8.48315C7.32558 8.67222 7.61278 8.777 7.91 8.78001V8.78001Z"
            fill="black"
          />
          <path
            d="M4.07999 12.9H5.83999C5.9726 12.9 6.09977 12.8473 6.19354 12.7535C6.28731 12.6598 6.33999 12.5326 6.33999 12.4C6.33999 12.2674 6.28731 12.1402 6.19354 12.0464C6.09977 11.9527 5.9726 11.9 5.83999 11.9H4.07999C3.94738 11.9 3.8202 11.9527 3.72643 12.0464C3.63267 12.1402 3.57999 12.2674 3.57999 12.4C3.58255 12.5318 3.63605 12.6575 3.72927 12.7507C3.82248 12.8439 3.94818 12.8974 4.07999 12.9V12.9Z"
            fill="black"
          />
          <path
            d="M7.20999 12.4C7.20999 12.5326 7.26267 12.6598 7.35644 12.7535C7.45021 12.8473 7.57738 12.9 7.70999 12.9H11.71C11.8426 12.9 11.9698 12.8473 12.0635 12.7535C12.1573 12.6598 12.21 12.5326 12.21 12.4C12.21 12.2674 12.1573 12.1402 12.0635 12.0464C11.9698 11.9527 11.8426 11.9 11.71 11.9H7.70999C7.57738 11.9 7.45021 11.9527 7.35644 12.0464C7.26267 12.1402 7.20999 12.2674 7.20999 12.4V12.4Z"
            fill="black"
          />
          <path
            d="M11.7 13.93H9.93997C9.80736 13.93 9.68019 13.9827 9.58642 14.0764C9.49265 14.1702 9.43997 14.2974 9.43997 14.43C9.44253 14.5618 9.49603 14.6875 9.58925 14.7807C9.68247 14.8739 9.80817 14.9274 9.93997 14.93H11.7C11.8326 14.93 11.9598 14.8773 12.0535 14.7835C12.1473 14.6898 12.2 14.5626 12.2 14.43C12.2 14.2974 12.1473 14.1702 12.0535 14.0764C11.9598 13.9827 11.8326 13.93 11.7 13.93Z"
            fill="black"
          />
          <path
            d="M8.57999 14.43C8.57999 14.2974 8.52731 14.1702 8.43354 14.0764C8.33977 13.9827 8.21259 13.93 8.07999 13.93H4.07999C3.94738 13.93 3.8202 13.9827 3.72643 14.0764C3.63267 14.1702 3.57999 14.2974 3.57999 14.43C3.57999 14.5626 3.63267 14.6898 3.72643 14.7835C3.8202 14.8773 3.94738 14.93 4.07999 14.93H8.07999C8.21179 14.9274 8.33749 14.8739 8.43071 14.7807C8.52393 14.6875 8.57743 14.5618 8.57999 14.43Z"
            fill="black"
          />
          <path
            d="M5.83999 16H4.07999C3.94738 16 3.8202 16.0527 3.72643 16.1464C3.63267 16.2402 3.57999 16.3674 3.57999 16.5C3.58255 16.6318 3.63605 16.7575 3.72927 16.8507C3.82248 16.9439 3.94818 16.9974 4.07999 17H5.83999C5.9726 17 6.09977 16.9473 6.19354 16.8536C6.28731 16.7598 6.33999 16.6326 6.33999 16.5C6.33999 16.3674 6.28731 16.2402 6.19354 16.1464C6.09977 16.0527 5.9726 16 5.83999 16V16Z"
            fill="black"
          />
          <path
            d="M11.7 16H7.69998C7.56737 16 7.4402 16.0527 7.34643 16.1464C7.25266 16.2402 7.19998 16.3674 7.19998 16.5C7.19998 16.6326 7.25266 16.7598 7.34643 16.8536C7.4402 16.9473 7.56737 17 7.69998 17H11.7C11.8326 17 11.9598 16.9473 12.0535 16.8536C12.1473 16.7598 12.2 16.6326 12.2 16.5C12.2 16.3674 12.1473 16.2402 12.0535 16.1464C11.9598 16.0527 11.8326 16 11.7 16V16Z"
            fill="black"
          />
        </svg>

        <p>TRXS</p>
      </a>
      <div className="side-bar__item" onClick={() => synchronize()}>
        <p>Sync</p>
      </div>
      <div
        className="side-bar__item"
        onClick={() => {
          invoke("force_update", { entity: entity });
        }}
      >
        <p>Force Sync</p>
      </div>
      <div
        className="side-bar__item"
        onClick={() => {
          checkForAppUpdates(true);
        }}
      >
        Check For Update
      </div>
      <a title="SETTINGS" className="side-bar__item" href="/home/settings">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
          <title>Settings</title>
          <g id="Layer_2" data-name="Layer 2">
            <g id="Layer_1-2" data-name="Layer 1">
              <path d="M59.2,23.58a4.41,4.41,0,0,1-2-4.86A9.79,9.79,0,0,0,45.27,6.81a4.4,4.4,  0,0,1-4.85-2,9.79,9.79,0,0,0-16.84,0,4.39,4.39,0,0,1-4.86,2A9.79,9.79,0,0,0,6.81,18.73a4.39,4.39,0,0,1-2,4.85,9.79,9.79,0,0,0,0,16.84,4.4,4.4,0,0,1,2,4.86A9.79,9.79,0,0,0,18.73,57.19a4.4,4.4,0,0,1,4.85,2,9.79,9.79,0,0,0,16.84,0,4.41,4.41,0,0,1,4.86-2A9.79,9.79,0,0,0,57.19,45.27a4.4,4.4,0,0,1,2-4.85,9.79,9.79,0,0,0,0-16.84ZM56.44,35.76A9.84,9.84,0,0,0,52,46.63a4.37,4.37,0,0,1-5.33,5.31,9.86,9.86,0,0,0-10.86,4.5,4.36,4.36,0,0,1-7.52,0,9.85,9.85,0,0,0-8.45-4.8,9.56,9.56,0,0,0-2.42.31,4.37,4.37,0,0,1-5.31-5.33,9.85,9.85,0,0,0-4.5-10.86,4.36,4.36,0,0,1,0-7.52,9.84,9.84,0,0,0,4.49-10.87,4.38,4.38,0,0,1,5.34-5.31,9.85,9.85,0,0,0,10.85-4.5,4.36,4.36,0,0,1,7.52,0,9.84,9.84,0,0,0,10.87,4.49A4.38,4.38,0,0,1,52,17.38a9.83,9.83,0,0,0,4.49,10.86,4.36,4.36,0,0,1,0,7.52Z" />
              <path d="M32,18.47A13.53,13.53,0,1,0,45.53,32,13.55,13.55,0,0,0,32,18.47Zm0,21.65A8.12,8.12,0,1,1,40.12,32,8.13,8.13,0,0,1,32,40.12Z" />
            </g>
          </g>
        </svg>
        <p>SETTINGS</p>
      </a>
    </div>
  );
}

export default SideBar;
